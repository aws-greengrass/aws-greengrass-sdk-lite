// aws-greengrass-sdk-lite - Lightweight AWS IoT Greengrass SDK
// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: Apache-2.0

#include <ggl/cleanup.h>
#include <ggl/log.h>
#include <pthread.h>
#include <sys/types.h>
#include <stdarg.h>
#include <stdint.h>
#include <stdio.h>

static pthread_mutex_t log_mutex = PTHREAD_MUTEX_INITIALIZER;

void ggl_log(
    uint32_t level,
    const char *file,
    int line,
    const char *tag,
    const char *format,
    ...
) {
    const char *level_str;
    switch (level) {
    case GGL_LOG_ERROR:
        level_str = "\033[1;31mE";
        break;
    case GGL_LOG_WARN:
        level_str = "\033[1;33mW";
        break;
    case GGL_LOG_INFO:
        level_str = "\033[0;32mI";
        break;
    case GGL_LOG_DEBUG:
        level_str = "\033[0;34mD";
        break;
    case GGL_LOG_TRACE:
        level_str = "\033[0;37mT";
        break;
    default:
        level_str = "\033[0;37m?";
    }

    {
        GGL_MTX_SCOPE_GUARD(&log_mutex);

        fprintf(stderr, "%s[%s] %s:%d: ", level_str, tag, file, line);

        va_list args;
        va_start(args, format);
        vfprintf(stderr, format, args);
        va_end(args);

        fprintf(stderr, "\033[0m\n");
        fflush(stderr);
    }
}
